<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主要取引先可視化ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        #chartContainer {
            width: 90%;
            /* 親要素の90%幅に */
            max-width: 800px;
            /* 最大幅は800px */
            height: auto;
            /* 高さは自動 */
            margin: auto;
        }

        #myChart {
            width: 100% !important;
            height: auto !important;
            /* 高さも自動に */
        }
    </style>

</head>

<body>
    <h1>主要取引先 円グラフ表示</h1>
    <label for="codeInput">証券コードを入力:</label>
    <input type="text" id="codeInput" placeholder="例: 1381">
    <button onclick="searchCompany()">検索</button>
    <p id="result"></p>

    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>


    <script>
        let jsonData = [];
        let chart = null;

        // JSONを読み込み
        fetch("result.json")
            .then(response => response.json())
            .then(data => {
                jsonData = data;
                // ページ読み込み時にクエリから読み取り
                const params = new URLSearchParams(window.location.search);
                const code = params.get("code");
                if (code) {
                    document.getElementById("codeInput").value = code;
                    searchCompany(code);
                }
            })
            .catch(error => console.error("読み込み失敗:", error));

        function searchCompany(codeFromParam = null) {
            const code = codeFromParam || document.getElementById("codeInput").value.trim();
            document.getElementById("codeInput").value = "";

            // URLを ?code=XXX に更新（履歴に残す）
            if (!codeFromParam) {
                const newUrl = `${window.location.pathname}?code=${encodeURIComponent(code)}`;
                history.pushState(null, "", newUrl);
            }

            const result = jsonData.find(item => item["証券コード"] === code);
            if (chart) chart.destroy();

            if (result) {
                let html = `企業名: ${result["企業名"]} <br> 業種: ${result["業種"]}`;

                if (result["主要取引先"].length > 0) {
                    html += "<h3>主要取引先</h3><ul>";
                    result["主要取引先"].forEach(client => {
                        html += `<li>${client["取引先名"]} - 金額: ${client["金額"]}, 割合: ${client["割合"]}%</li>`;
                    });
                    html += "</ul>";
                } else {
                    html += "<p>主要取引先は登録されていません。</p>";
                }
                document.getElementById("result").innerHTML = html;

                const labels = result["主要取引先"].map(c => c["取引先名"]);
                const data = result["主要取引先"].map(c => parseFloat(c["割合"]));

                const total = data.reduce((a, b) => a + b, 0);
                if (total < 100) {
                    labels.push("その他");
                    data.push(100 - total);
                }

                let baseColors = [
                    "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF",
                    "#FF9F40", "#8AC926", "#1982C4", "#6A4C93", "#FF595E"
                ];
                const backgroundColors = labels.map((l, i) => l === "その他" ? "#C9CBCF" : baseColors[i % baseColors.length]);

                const ctx = document.getElementById("myChart").getContext("2d");
                chart = new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            datalabels: {
                                formatter: (value) => value.toFixed(1) + '%',
                                color: "#000",
                                font: { weight: "bold", size: 12 }
                            },
                            legend: { position: "right" }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                document.getElementById("result").textContent =
                    `${code}: 該当する証券コードは見つかりませんでした。`;
            }
        }

        // Enterキーでも検索できるようにする
        document.getElementById("codeInput").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                searchCompany();
            }
        });
    </script>

</body>

</html>
